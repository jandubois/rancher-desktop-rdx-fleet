#!/bin/sh
# Log out from a Helm OCI registry
# Usage: helm-registry-logout <registry>
#
# This uses the helm registry logout command to remove authentication for an OCI registry.

set -e

if [ $# -ne 1 ]; then
  echo '{"error":"Usage: helm-registry-logout <registry>"}' >&2
  exit 1
fi

REGISTRY="$1"

# Find helm binary - check common macOS locations
find_helm() {
  # Check PATH first (includes ~/.rd/bin if shell is configured)
  if command -v helm >/dev/null 2>&1; then
    command -v helm
    return 0
  fi

  # Check common macOS locations (including Rancher Desktop's ~/.rd/bin)
  for dir in "$HOME/.rd/bin" /usr/local/bin /opt/homebrew/bin; do
    if [ -x "$dir/helm" ]; then
      echo "$dir/helm"
      return 0
    fi
  done

  return 1
}

HELM_PATH=$(find_helm)

if [ -z "$HELM_PATH" ]; then
  echo '{"error":"helm command not found","debug":"Searched PATH and common locations"}'
  exit 1
fi

# Run helm registry logout
if "$HELM_PATH" registry logout "$REGISTRY" 2>&1; then
  echo '{"success":true}'
else
  # Logout may fail if not logged in, which is fine
  echo '{"success":true,"note":"may not have been logged in"}'
fi
