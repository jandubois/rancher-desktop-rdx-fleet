#!/bin/sh
# Store a credential using the Docker credential helper
# Usage: cred-store <server> <username> <secret>
#
# This uses the configured Docker credential helper to store credentials.
# The credential helper is determined from ~/.docker/config.json credsStore.

set -e

if [ $# -ne 3 ]; then
  echo "Usage: cred-store <server> <username> <secret>" >&2
  exit 1
fi

SERVER="$1"
USERNAME="$2"
SECRET="$3"

DOCKER_CONFIG="${DOCKER_CONFIG:-$HOME/.docker}"
CONFIG_FILE="$DOCKER_CONFIG/config.json"

# Get the configured credential helper
get_creds_store() {
  if [ -f "$CONFIG_FILE" ]; then
    grep -o '"credsStore"[[:space:]]*:[[:space:]]*"[^"]*"' "$CONFIG_FILE" 2>/dev/null | sed 's/.*: *"\([^"]*\)".*/\1/'
  fi
}

CREDS_STORE=$(get_creds_store)

if [ -z "$CREDS_STORE" ]; then
  # Try to find an available helper
  for helper in secretservice pass osxkeychain wincred; do
    if command -v "docker-credential-$helper" >/dev/null 2>&1; then
      CREDS_STORE="$helper"
      break
    fi
  done
fi

if [ -z "$CREDS_STORE" ]; then
  echo "No credential helper available. Please install docker-credential-secretservice or docker-credential-pass." >&2
  exit 1
fi

HELPER="docker-credential-$CREDS_STORE"

if ! command -v "$HELPER" >/dev/null 2>&1; then
  echo "Credential helper '$HELPER' not found" >&2
  exit 1
fi

# Store the credential using the helper
# The helper expects JSON on stdin
printf '{"ServerURL":"%s","Username":"%s","Secret":"%s"}' "$SERVER" "$USERNAME" "$SECRET" | "$HELPER" store

echo "Credential stored successfully"
