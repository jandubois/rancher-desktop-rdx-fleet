# Fleet GitOps Extension Backend Service
#
# RANCHER DESKTOP WORKAROUNDS:
# 1. ${DESKTOP_PLUGIN_IMAGE} is not expanded - must use a pre-processed compose file
# 2. pull_policy: never - required for locally-built images
#
# See docs/rancher-desktop-bugs.md for details

services:
  backend:
    # Use the same image as the extension itself for the backend service.
    # Docker Desktop expands ${DESKTOP_PLUGIN_IMAGE} automatically.
    # Rancher Desktop does NOT expand this variable - the Dockerfile uses
    # envsubst to replace it at build time with the actual image name.
    image: ${DESKTOP_PLUGIN_IMAGE}
    pull_policy: never

    # Mount Docker socket to check running containers
    # Uses .raw variant as recommended for extensions in Docker Desktop VM
    volumes:
      - /var/run/docker.sock.raw:/var/run/docker.sock

    # Environment variables for extension identification
    environment:
      - EXTENSION_NAME=fleet-gitops
      - EXTENSION_TYPE=base
      - EXTENSION_VERSION=1.0.0

    # Health check - verify socket exists
    healthcheck:
      test: ["CMD", "test", "-S", "/run/guest-services/fleet-gitops.sock"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
