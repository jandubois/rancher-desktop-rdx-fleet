# Fleet GitOps Extension Backend Service
#
# RANCHER DESKTOP WORKAROUNDS:
# 1. pull_policy: never - required for locally-built images
#
# See docs/reference/rancher-desktop-extension-bugs.md for details

services:
  backend:
    # Use the same image as the extension itself for the backend service.
    # Both Docker Desktop and Rancher Desktop expand ${DESKTOP_PLUGIN_IMAGE} automatically.
    image: ${DESKTOP_PLUGIN_IMAGE}
    pull_policy: never

    # Privileged mode to access root-owned k3s kubeconfig
    privileged: true

    # Mount Docker socket for container inspection
    # Uses .raw variant as recommended for extensions in Docker Desktop VM
    # Mount k3s kubeconfig for Kubernetes access (requires privileged mode)
    volumes:
      - /var/run/docker.sock.raw:/var/run/docker.sock
      - /etc/rancher/k3s/k3s.yaml:/etc/rancher/k3s/k3s.yaml:ro

    # Environment variables for extension identification
    environment:
      - EXTENSION_NAME=fleet-gitops
      - EXTENSION_TYPE=base
      - EXTENSION_VERSION=1.0.0

    # Health check - verify socket exists
    healthcheck:
      test: ["CMD", "test", "-S", "/run/guest-services/fleet-gitops.sock"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
